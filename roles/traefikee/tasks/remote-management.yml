---
- name: Export cluster configuration from controller
  ansible.builtin.shell:
    cmd: "/usr/local/bin/traefikee generate credentials --onpremise.hosts={{ ansible_default_ipv4.address }} --cluster=default --socket=/opt/traefikee/run/teectl.sock > config.yaml"
  changed_when: true
  environment:
    chdir: "{{ ansible_user_dir }}"
  delegate_to: "{{ groups['traefikee_controllers'] | first }}"
  run_once: true

- name: Read cluster configuration
  ansible.builtin.command:
    cmd: "cat {{ ansible_user_dir }}/config.yaml"
  delegate_to: "{{ groups['traefikee_controllers'] | first }}"
  changed_when: false
  run_once: true
  register: traefikee_cluster_configuration

- name: Transfer cluster configuration
  ansible.builtin.copy:
    dest: "/home/{{ ansible_env.SUDO_USER }}/config.yaml"
    content: "{{ traefikee_cluster_configuration.stdout }}"
    mode: 0644
  delegate_to: localhost
  become: false

- name: Import cluster configuration into management station
  ansible.builtin.command:
    cmd: "/usr/local/bin/teectl cluster import --file=/home/{{ ansible_env.SUDO_USER }}/config.yaml"
  changed_when: false
  delegate_to: localhost
  become: false

- name: Ensure configuration on management station
  ansible.builtin.copy:
    src: "{{ item }}"
    dest: "/home/{{ ansible_env.SUDO_USER }}/{{ item }}"
    mode: 0644
  delegate_to: localhost
  become: false
  with_items:
    - traefikee-config-static.yml
    - traefikee-config-dynamic.yml
